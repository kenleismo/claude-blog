---
import BaseLayout from '../layouts/BaseLayout.astro';

const posts = await Astro.glob('../pages/blog/*.{md,mdx}');

function parseDate(dateString) {
  if (!dateString) return new Date(0);
  
  const match = dateString.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (match) {
    const [, year, month, day] = match;
    return new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
  }
  
  return new Date(dateString);
}

const sortedPosts = posts
  .filter(post => post.frontmatter.publishDate)
  .sort((a, b) => parseDate(b.frontmatter.publishDate).getTime() - parseDate(a.frontmatter.publishDate).getTime());

const postsByYear = sortedPosts.reduce((acc, post) => {
  const year = parseDate(post.frontmatter.publishDate).getFullYear();
  if (!acc[year]) {
    acc[year] = [];
  }
  acc[year].push(post);
  return acc;
}, {});

const years = Object.keys(postsByYear).sort((a, b) => b - a);
---

<BaseLayout title="Tech Notes - 技术博客">
  <div class="mb-12">
    <h1 class="text-3xl font-bold text-gray-900 mb-2">技术博客</h1>
    <p class="text-gray-600"></p>
  </div>

  {years.map((year) => (
    <section class="mb-12">
      <h2 class="text-2xl font-semibold text-gray-800 mb-6">{year}</h2>
      <div class="space-y-6">
        {postsByYear[year].map((post) => {
          const publishDate = post.frontmatter.publishDate || '';
          const match = publishDate.match(/^(\d{4})-(\d{2})-(\d{2})$/);
          const displayDate = match ? `${match[2]}/${match[3]}` : publishDate;

          return (
            <article class="group">
              <div class="flex items-baseline gap-4">
                <time class="text-gray-500 text-sm font-mono w-12 flex-shrink-0">
                  {displayDate}
                </time>
                <div class="flex-1">
                  <h3>
                    <a
                      href={post.url}
                      class="text-gray-900 hover:text-blue-600 transition-colors group-hover:text-blue-600"
                    >
                      {post.frontmatter.title}
                    </a>
                  </h3>
                </div>
              </div>
            </article>
          );
        })}
      </div>
    </section>
  ))}

  {sortedPosts.length === 0 && (
    <div class="text-center py-12">
      <p class="text-gray-500">暂无博客文章</p>
    </div>
  )}
</BaseLayout>